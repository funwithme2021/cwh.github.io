<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>åˆ—è»Šé‹è¡Œå‹•æ…‹åœ–</title>
  <style>
    /* --- ä½¿ç”¨ CSS è®Šæ•¸å®šç¾©æ·ºè‰²/æ·±è‰²ä¸»é¡Œ --- */
    :root {
      --bg-color: #f0f2f5;       /* èƒŒæ™¯è‰² (æ·º) */
      --text-color: #333;        /* æ–‡å­—è‰² (æ·º) */
      --panel-bg: #fff;          /* é¢æ¿èƒŒæ™¯ (æ·º) */
      --panel-border: #ddd;      /* é¢æ¿é‚Šæ¡† (æ·º) */
      --station-line-bg: #ccc;   /* è·¯ç·šåº•è‰² (æ·º) */
    }
    [data-theme="dark"] {
      --bg-color: #1d1f21;       /* èƒŒæ™¯è‰² (æ·±) */
      --text-color: #ccc;        /* æ–‡å­—è‰² (æ·±) */
      --panel-bg: #2c2f33;       /* é¢æ¿èƒŒæ™¯ (æ·±) */
      --panel-border: #555;      /* é¢æ¿é‚Šæ¡† (æ·±) */
      --station-line-bg: #666;   /* è·¯ç·šåº•è‰² (æ·±) */
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s; /* ä¸»é¡Œåˆ‡æ›æ¼¸è®Š */
    }

    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: var(--panel-bg);
      border-bottom: 1px solid var(--panel-border);
      padding: 5px 0;
    }

    .control-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #simTimeLabel {
      font-size: 14px;
    }

    select, button {
      font-size: 14px;
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }

    .main-layout {
      display: flex;
      flex: 1;
      height: 100%;
    }

    .container {
      width: 70%;
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar {
      width: 30%;
      border-left: 1px solid var(--panel-border);
      background: var(--panel-bg);
      padding: 20px;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
      overflow-y: auto;
      transition: background 0.3s;
    }

    h1 {
      font-size: 28px;
      text-align: center;
      margin-bottom: 10px;
    }

    #currentTime {
      font-size: 16px;
      text-align: center;
      margin-bottom: 10px;
    }

    #searchBox {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }

    #searchInput, #trainSearchInput {
      font-size: 14px;
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 80%;
      color: #333;
    }

    .station-line {
      position: relative;
      width: 6px;
      height: 5500px;
      margin: 0 auto;
      background: var(--station-line-bg);
      z-index: 1;
      transition: background 0.3s;
    }

    .station-dot {
      position: absolute;
      left: 50%;
      width: 7px;
      height: 7px;
      background: #333;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }

    .station-label {
      position: absolute;
      font-size: 13px;
      transform: translateY(-50%);
      white-space: nowrap;
      right: 20px;
      font-weight: bold;
      cursor: pointer;
    }

    .station-label.highlight {
      font-weight: bold;
      color: #007BFF;
    }

    .incoming-train-indicator {
      color: #e60000;
      margin-left: 5px;
    }

    .train-marker {
      position: absolute;
      left: 0%;
      transform: translateX(-1.5%);
      display: flex;
      align-items: center;
      cursor: pointer;
      z-index: 4;
      font-weight: bold;
    }

    .train-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #000;
      border: 2px solid #fff;
    }

    .train-dot.soon-arriving {
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .train-label {
      font-size: 12px;
      margin-left: 6px;
      white-space: nowrap;
    }

    .train-info-item {
      background: #fdfdfd;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s ease;
      color: #333;  /* æ·ºè‰²æ–‡å­— */
    }

    .train-info-item:hover {
      background: #f5f5f5;
    }

    .filter-box {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .filter-box label {
      display: flex;
      align-items: center;
    }

    #modal, #stationModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--panel-bg);
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 100;
      max-height: 70vh;
      overflow-y: auto;
      display: none;
      border-radius: 8px;
      border: 1px solid var(--panel-border);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    #modalClose, #stationModalClose {
      float: right;
      color: #f00;
      font-weight: bold;
      cursor: pointer;
    }

    /* ç”¨ä¾†ç•«ã€Œå€æ®µåˆ—è»Šå¯†é›†åº¦ã€çš„è‰²å¡Š */
    #hotnessCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
      pointer-events: none;
    }

    /* å€æ®µæµé‡æŠ˜ç·šåœ– (flowChartCanvas) æ”¾åœ¨å³å´ */
    #flowChartCanvas {
      margin-top: 10px;
      background: #fff;
      border: 1px solid #ccc;
      display: block;
      width: 100%;
      height: 170px;
      max-width: 100%;
    }
  </style>
</head>

<body>
  <div class="controls"></div>

  <div class="main-layout">
    <div class="container">
      <h1>åˆ—è»Šé‹è¡Œå‹•æ…‹åœ–</h1>
      <div id="currentTime">ç¾åœ¨æ™‚é–“ï¼š--:--:--</div>
      <div id="searchBox">
        <input type="text" id="searchInput" placeholder="æœå°‹ç«™åä¸¦è·³è‡³ä½ç½®..." />
      </div>

      <!-- è·¯ç·šåœ– (å«å€æ®µç†±åº¦Canvas) -->
      <div id="stationLine" class="station-line"></div>
    </div>

    <div class="sidebar">
        <!-- å€æ®µæµé‡æŠ˜ç·šåœ– -->
      <canvas id="flowChartCanvas" ></canvas>
      <h3>è¡Œé€²ä¸­è»Šæ¬¡</h3>
      <input type="text" id="trainSearchInput" placeholder="è¼¸å…¥è»Šæ¬¡æˆ–è»Šç¨®æœå°‹..." />
      <div class="filter-box">
        <label><input type="checkbox" class="filter-checkbox" value="æ–°è‡ªå¼·" checked> æ–°è‡ªå¼·</label>
        <label><input type="checkbox" class="filter-checkbox" value="æ™®æ‚ ç‘ª" checked> æ™®æ‚ ç‘ª</label>
        <label><input type="checkbox" class="filter-checkbox" value="è‡ªå¼·è™Ÿ(æ–°)" checked> è‡ªå¼·è™Ÿ(æ–°)</label>
        <label><input type="checkbox" class="filter-checkbox" value="è‡ªå¼·è™Ÿ" checked> è‡ªå¼·è™Ÿ</label>
        <label><input type="checkbox" class="filter-checkbox" value="è’å…‰è™Ÿ" checked> è’å…‰è™Ÿ</label>
        <label><input type="checkbox" class="filter-checkbox" value="å¾©èˆˆè™Ÿ" checked> å¾©èˆˆè™Ÿ</label>
        <label><input type="checkbox" class="filter-checkbox" value="å€é–“å¿«" checked> å€é–“å¿«</label>
        <label><input type="checkbox" class="filter-checkbox" value="å€é–“è»Š" checked> å€é–“è»Š</label>
        <label><input type="checkbox" class="filter-checkbox" value="åŠ ç­è»Š" checked> åŠ ç­è»Š</label>
      </div>
      <div id="trainInfoList"></div>

      
    </div>

    <!-- Modal -->
    <div id="modal">
      <span id="modalClose">[X]</span>
      <h3 id="modalTitle"></h3>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- è¼‰å…¥åˆ—è»Šè³‡æ–™ -->
  <script src="train-schedule.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* ========== ä¸»é¡Œåˆ‡æ›ã€æ™‚é–“æ»‘æ¡¿ã€é€Ÿåº¦æ§åˆ¶ç­‰æŒ‰éˆ•å€ ========== */
      const themeToggleBtn = document.createElement('button');
      themeToggleBtn.innerText = 'åˆ‡æ›ä¸»é¡Œ';
      themeToggleBtn.style.marginRight = '10px';
      themeToggleBtn.onclick = () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        if (currentTheme === 'dark') {
          document.documentElement.removeAttribute('data-theme');
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
        }
        // é¡¯ç¤ºæ¨¡å¼æ”¹è®Šå¾Œï¼Œç‚ºäº†è®“ã€Œå€é–“è»Šã€é¡è‰²éš¨ä¹‹æ›´æ–°ï¼Œé‡æ–°update
        updateTrains(parseInt(timeSlider.value));
      };

      const sliderContainer = document.createElement('div');
      sliderContainer.style.textAlign = 'center';
      sliderContainer.style.margin = '10px';

      const sliderLabel = document.createElement('span');
      sliderLabel.innerText = 'æ¨¡æ“¬æ™‚é–“ï¼š';
      sliderLabel.id = 'simTimeLabel';
      sliderLabel.style.marginRight = '8px';

      const timeSlider = document.createElement('input');
      timeSlider.type = 'range';
      timeSlider.min = 0;
      timeSlider.max = 1439;
      timeSlider.value = new Date().getHours() * 60 + new Date().getMinutes();
      timeSlider.id = 'timeSlider';
      timeSlider.style.width = '300px';

      sliderContainer.appendChild(sliderLabel);
      sliderContainer.appendChild(timeSlider);

      const controlBar = document.createElement('div');
      controlBar.style.textAlign = 'center';
      controlBar.style.marginBottom = '10px';

      const toggleModeBtn = document.createElement('button');
      toggleModeBtn.innerText = 'åˆ‡æ›ç‚ºå¯¦æ™‚æ¨¡å¼';
      toggleModeBtn.style.marginRight = '10px';

      const togglePlayBtn = document.createElement('button');
      togglePlayBtn.innerText = 'â¸ æš«åœæ¨¡æ“¬';

      controlBar.appendChild(themeToggleBtn);
      controlBar.appendChild(toggleModeBtn);
      controlBar.appendChild(togglePlayBtn);

      const speedSelect = document.createElement('select');
      speedSelect.innerHTML = `
        <option value="1">1X</option>
        <option value="2">2X</option>
        <option value="5">5X</option>
        <option value="10">10X</option>
        <option value="20">20X</option>
        <option value="30">30X</option>
        <option value="60">60X</option>
      `;
      speedSelect.style.marginLeft = '10px';
      controlBar.appendChild(speedSelect);

      document.body.insertBefore(controlBar, document.body.firstChild);
      document.body.insertBefore(sliderContainer, controlBar.nextSibling);

      let speedMultiplier = 1;
      speedSelect.addEventListener('change', () => {
        speedMultiplier = parseInt(speedSelect.value);
      });

      let useRealtime = false;
      let autoAdvance = true;

      togglePlayBtn.onclick = () => {
        autoAdvance = !autoAdvance;
        togglePlayBtn.innerText = autoAdvance ? 'â¸ æš«åœæ¨¡æ“¬' : 'â–¶ï¸ æ’­æ”¾æ¨¡æ“¬';
      };

      toggleModeBtn.onclick = () => {
        useRealtime = !useRealtime;
        toggleModeBtn.innerText = useRealtime ? 'åˆ‡æ›ç‚ºæ¨¡æ“¬æ¨¡å¼' : 'åˆ‡æ›ç‚ºå¯¦æ™‚æ¨¡å¼';
        if (useRealtime) {
          const now = new Date();
          const currentMinutes = now.getHours()*60 + now.getMinutes();
          timeSlider.value = currentMinutes;
          updateTrains(currentMinutes);
        }
      };

      /* ========== å…¶é¤˜ UI/è³‡æ–™åˆå§‹è¨­å®š ========== */
      function updateTimeDisplay() {
        const now = new Date();
        document.getElementById("currentTime").innerText = `ç¾åœ¨æ™‚é–“ï¼š${now.toLocaleTimeString('zh-TW')}`;
      }
      setInterval(updateTimeDisplay, 1000);
      updateTimeDisplay();

      const stationLine = document.getElementById('stationLine');
      const stationCount = stations.length;

      // ç”¨ä¾†ç•«å€æ®µç†±åº¦
      const hotnessCanvas = document.createElement('canvas');
      hotnessCanvas.id = 'hotnessCanvas';
      stationLine.appendChild(hotnessCanvas);

      // è»Šç«™åœ“é»èˆ‡æ¨™ç±¤
      stations.forEach((stationName, index) => {
        const percent = (index / (stationCount - 1)) * 100;
        const dot = document.createElement('div');
        dot.className = 'station-dot';
        dot.style.top = percent + '%';

        const label = document.createElement('div');
        label.className = 'station-label';
        label.style.top = percent + '%';
        label.innerText = stationName;
        label.dataset.name = stationName;

        // é»æ“Šç«™å -> é¡¯ç¤ºå½ˆçª—
        label.addEventListener('click', () => {
          const currentMinutes = parseInt(timeSlider.value);
          const trainsPassing = Object.entries(trainSchedule).filter(([no, train]) => {
            const times = train['è»Šç«™æ™‚é–“'];
            return times.some(([s, t]) => {
              const mm = timeToMinutes(t);
              return s===stationName && mm >= currentMinutes-10 && mm <= currentMinutes+30;
            });
          });
          const list = trainsPassing.map(([no, train]) => `<li>${no}æ¬¡ ${train['è»Šç¨®']}</li>`).join('');
          stationModalTitle.innerText = `${stationName} é€šéåˆ—è»Š`;
          stationModalContent.innerHTML = `<ul>${list || '<li>ç„¡åˆ—è»Šé€šé</li>'}</ul>`;
          stationModal.style.display = 'block';
        });

        stationLine.appendChild(dot);
        stationLine.appendChild(label);
      });

      /* è»Šç«™ Modal */
      const stationModal = document.createElement('div');
      stationModal.id = 'stationModal';
      stationModal.style.display = 'none';
      stationModal.innerHTML = `
        <span id="stationModalClose" style="float:right;cursor:pointer;color:red">[X]</span>
        <h3 id="stationModalTitle"></h3>
        <div id="stationModalContent"></div>
      `;
      document.body.appendChild(stationModal);

      const stationModalClose = stationModal.querySelector('#stationModalClose');
      stationModalClose.onclick = () => {
        stationModal.style.display = 'none';
      };
      const stationModalTitle = stationModal.querySelector('#stationModalTitle');
      const stationModalContent = stationModal.querySelector('#stationModalContent');

      // ä¸» Modal (é¡¯ç¤ºè»Šæ¬¡æ˜ç´°)
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      document.getElementById('modalClose').onclick = () => {
        modal.style.display = 'none';
        autoScrollTrainNo = null;
      };

      /* åˆ—è»Šè»Šç¨®é…è‰²ï¼ˆé è¨­ï¼‰ */
      const trainTypeColors = {
        'è‡ªå¼·è™Ÿ': 'red', 'æ–°è‡ªå¼·': '#8600FF', 'æ™®æ‚ ç‘ª': '#FF1493',
        'è‡ªå¼·è™Ÿ(æ–°)': 'brown', 'è’å…‰è™Ÿ': 'orange', 'åŠ ç­è»Š': 'teal',
        'å¾©èˆˆè™Ÿ': '#0080FF', 'å€é–“å¿«': 'green', 'å€é–“è»Š': 'black'
      };

      // æ ¹æ“šç•¶å‰ä¸»é¡Œï¼Œè‹¥æ˜¯å€é–“è»Šä¸”é»‘å¤œæ¨¡å¼ï¼Œå°±æ”¹æˆç™½è‰²
      function getTrainColor(trainType) {
        let baseColor = trainTypeColors[trainType] || '#000';
        const currentTheme = document.documentElement.getAttribute('data-theme');
        if (trainType === 'å€é–“è»Š' && currentTheme === 'dark') {
          return '#fff'; // é»‘å¤œæ¨¡å¼æ™‚ï¼Œå€é–“è»Šæ”¹æˆç™½è‰²
        }
        return baseColor;
      }

      // æ–°ä¸Šç·šåˆ—è»Šé€šçŸ¥
      let previousActiveTrains = new Set();
      function notifyNewTrains(currentTrainNos) {
        const currentSet = new Set(currentTrainNos);
        const newTrains = [...currentSet].filter(trainNo => !previousActiveTrains.has(trainNo));
        if (newTrains.length>0) {
          const messages = newTrains.map(trainNo => {
            const data = trainSchedule[trainNo];
            if(!data) return `ğŸš† ${trainNo}ï¼ˆè³‡æ–™ç¼ºå¤±ï¼‰`;
            const type = data.è»Šç¨® || 'æœªçŸ¥è»Šç¨®';
            const arr = data.è»Šç«™æ™‚é–“||[];
            const from = arr[0]?.[0]||'æœªçŸ¥èµ·é»';
            const to = arr[arr.length-1]?.[0]||'æœªçŸ¥çµ‚é»';
            return `ğŸš† ${trainNo} ${type}ï¼ˆ${from} â ${to}ï¼‰`;
          });
          const popup = document.createElement('div');
          popup.style.position = 'fixed';
          popup.style.top = '20px';
          popup.style.right = '20px';
          popup.style.padding = '12px 18px';
          popup.style.backgroundColor = '#e6f7ff';
          popup.style.border = '1px solid #91d5ff';
          popup.style.borderRadius = '8px';
          popup.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
          popup.style.zIndex = 10000;
          popup.style.fontSize = '15px';
          popup.style.color = '#004b6e';
          popup.innerHTML = messages.join('<br>');
          document.body.appendChild(popup);
          setTimeout(()=>popup.remove(), 5000);
        }
        previousActiveTrains = currentSet;
      }

      function timeToMinutes(t) {
        const [h,m] = t.split(':');
        return parseInt(h)*60 + parseInt(m);
      }

      function getTrainPosition(trainData, currentMinutes) {
        const arr = trainData['è»Šç«™æ™‚é–“'];
        const stationTimes = arr.map(([st, stime])=>({
          station: st,
          timeMinutes: timeToMinutes(stime)
        }));
        for(let i=0; i<stationTimes.length-1; i++){
          const t1 = stationTimes[i].timeMinutes;
          const t2 = stationTimes[i+1].timeMinutes;
          if(currentMinutes>=t1 && currentMinutes<=t2){
            const ratio = (currentMinutes - t1)/(t2 - t1);
            const s1 = stations.indexOf(stationTimes[i].station);
            const s2 = stations.indexOf(stationTimes[i+1].station);
            if(s1===-1 || s2===-1) return {running:false};
            const interpolatedIndex = s1 + ratio*(s2-s1);
            return {
              running:true,
              startTime: stationTimes[0].timeMinutes,
              endTime: stationTimes[stationTimes.length-1].timeMinutes,
              nextStation: stationTimes[i+1].station,
              nextTime: arr[i+1][1],
              segmentIndex: interpolatedIndex,
              currentBetweenStart: stations[Math.floor(interpolatedIndex)],
              currentBetweenEnd: stations[Math.ceil(interpolatedIndex)]
            }
          }
        }
        return {running:false};
      }

      let autoScrollTrainNo = null;
      let incomingMap = {};
      let segmentCounts = Array(stationCount-1).fill(0);

      // ã€Œå€æ®µæµé‡ã€æŠ˜ç·šåœ–è³‡æ–™
      let flowHistory = [];

      // é¡¯ç¤ºã€Œé»ƒâ†’æ©˜â†’ç´…ã€æ¼¸å±¤
      function getDensityColor(ratio) {
        if(ratio<0) ratio=0;
        if(ratio>1) ratio=1;
        // 0~0.4 => é»ƒ->æ©˜, 0.4~1 => æ©˜->ç´…
        if(ratio<=0.4){
          const norm = ratio/0.4; // 0..1
          const g = 300 - (255-165)*norm; // 255->165
          return `rgba(255, ${g}, 0, 0.7)`;
        } else {
          const norm = (ratio-0.4)/0.4;
          const g = 165 - 165*norm; // 165->0
          return `rgba(255, ${g}, 0, 0.7)`;
        }
      }

      // ç¹ªè£½å€æ®µç†±åº¦ canvas
      function drawHotnessCanvas() {
        hotnessCanvas.width = stationLine.offsetWidth;
        hotnessCanvas.height = stationLine.offsetHeight;
        const ctx = hotnessCanvas.getContext('2d');
        ctx.clearRect(0,0,hotnessCanvas.width, hotnessCanvas.height);

        const maxCount = Math.max(...segmentCounts);
        if(maxCount===0) return;

        const segHeight = hotnessCanvas.height / (stationCount-1);
        for(let i=0; i<segmentCounts.length; i++){
          const count = segmentCounts[i];
          if(count===0) continue;
          const ratio = count/maxCount;
          ctx.fillStyle = getDensityColor(ratio);
          const rectX = (hotnessCanvas.width-6)/2;
          const rectY = i*segHeight;
          ctx.fillRect(rectX, rectY, 6, segHeight);
        }
      }

      // ç¹ªè£½ã€Œå€æ®µæµé‡ã€æŠ˜ç·šåœ–(å³ä¸‹)
      function drawFlowChart() {
        const c = document.getElementById('flowChartCanvas');
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,c.width,c.height);

        if(flowHistory.length<2) {
          ctx.font='14px sans-serif';
          ctx.fillStyle='#666';
          ctx.fillText('å€æ®µæµé‡æŠ˜ç·šåœ– (æš«ç„¡è³‡æ–™)', 20,30);
          return;
        }

        const maxFlow = Math.max(...flowHistory.map(d=>d.flow));
        const margin=20;
        const w = c.width - margin*2;
        const h = c.height- margin*2;

        // åº§æ¨™è»¸
        ctx.strokeStyle='#aaa';
        ctx.beginPath();
        ctx.moveTo(margin, margin);
        ctx.lineTo(margin, margin+h);
        ctx.lineTo(margin+w, margin+h);
        ctx.stroke();

        // é€£ç·š
        ctx.strokeStyle='blue';
        ctx.beginPath();
        flowHistory.forEach((d,i)=>{
          const x = margin + i/(flowHistory.length-1)*w;
          const y = margin + h - (d.flow/maxFlow)*h;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        });
        ctx.stroke();

        // ç¹ªé»
        ctx.fillStyle='blue';
        flowHistory.forEach((d,i)=>{
          const x = margin + i/(flowHistory.length-1)*w;
          const y = margin + h - (d.flow/maxFlow)*h;
          ctx.beginPath();
          ctx.arc(x,y,3,0,2*Math.PI);
          ctx.fill();
          if(i===flowHistory.length-1){
            ctx.fillText(`æµé‡:${d.flow}`, x+5, y-5);
          }
        });
      }

      // === æ ¸å¿ƒï¼šæ›´æ–°åˆ—è»Šä½ç½® ===
      function updateTrains(currentMinutes=null) {
        // æ¸…é™¤èˆŠ marker
        document.querySelectorAll('.train-marker').forEach(el => el.remove());
        segmentCounts.fill(0);
        incomingMap={};

        if(currentMinutes===null) {
          const now = new Date();
          currentMinutes = now.getHours()*60 + now.getMinutes();
        }
        document.getElementById("simTimeLabel").innerText =
          `æ¨¡æ“¬æ™‚é–“ï¼š${String(Math.floor(currentMinutes/60)).padStart(2,'0')}:${String(currentMinutes%60).padStart(2,'0')}`;

        const infoList = document.getElementById('trainInfoList');
        infoList.innerHTML="";
        const checkedTypes = [...document.querySelectorAll('.filter-checkbox:checked')].map(cb=>cb.value);
        const keyword = document.getElementById('trainSearchInput')?.value.trim() || "";

        const currentTrainNos=[];
        Object.keys(trainSchedule).forEach(trainNo=>{
          const trainData = trainSchedule[trainNo];
          const trainType = trainData['è»Šç¨®'];
          if(!checkedTypes.includes(trainType)) return;
          if(keyword && !trainNo.includes(keyword) && !trainType.includes(keyword)) return;

          const posInfo = getTrainPosition(trainData, currentMinutes);
          if(!posInfo.running) return;

          const totalDuration = posInfo.endTime - posInfo.startTime;
          const traveled = currentMinutes - posInfo.startTime;
          const remain = posInfo.endTime - currentMinutes;
          let progress=0;
          if(totalDuration>0) {
            progress = traveled/totalDuration *100;
            if(progress<0) progress=0;
            if(progress>100) progress=100;
          }

          const percent = (posInfo.segmentIndex/(stationCount-1))*100;
          const marker = document.createElement('div');
          marker.className='train-marker';
          marker.style.top = percent + '%';
          marker.dataset.trainNo = trainNo;

          // å–å¾—åˆ—è»Šé…è‰²(å€é–“è»Šåœ¨æ·±è‰²æ¨¡å¼è‡ªå‹•æ”¹æˆç™½)
          const color = getTrainColor(trainType);

          const dot = document.createElement('div');
          dot.className='train-dot';
          if(posInfo.nextTime) {
            const nextStopTime = timeToMinutes(posInfo.nextTime);
            const remaining = nextStopTime - currentMinutes;
            if(remaining<=2){
              dot.classList.add('soon-arriving');
              if(posInfo.nextStation) incomingMap[posInfo.nextStation]=true;
            }
          }
          dot.style.backgroundColor=color;

          const arr=trainData['è»Šç«™æ™‚é–“']||[];
          const fromStation1= arr[0]?.[0]|| 'æœªçŸ¥';
          const toStation1= arr[arr.length-1]?.[0]|| 'æœªçŸ¥';

          const label = document.createElement('div');
          label.className='train-label';
          label.innerHTML = `ğŸš†${trainNo}æ¬¡ <span style="color:${color}">${trainType}</span>ï¼ˆ${fromStation1} â ${toStation1}ï¼‰`;

          marker.onclick = ()=>{
            const list = trainData['è»Šç«™æ™‚é–“'].map(s=> `<li>${s[0]} - ${s[1]}</li>`).join('');
            // åœ¨ Modal é¡¯ç¤ºå…¨ç¨‹æ™‚é–“ã€å·²è¡Œé§›ã€å‰©é¤˜ã€å®Œæˆåº¦
            modalTitle.innerText = `${trainNo}æ¬¡ ${trainType}ï¼ˆ${fromStation1} â ${toStation1}ï¼‰`;
            const detail=`
              <p>å·²è¡Œä½¿ï¼š${Math.max(0,traveled)}/${Math.max(0,totalDuration)} åˆ†é˜(å®Œæˆ${progress.toFixed(1)}%)</p>
              <p>å‰©é¤˜ï¼š${Math.max(0,remain)} åˆ†é˜æŠµé”çµ‚é»ç«™ã€‚</p>
              <ul>${list}</ul>
            `;
            modalContent.innerHTML=detail;
            modal.style.display='block';
            autoScrollTrainNo= trainNo;
          };
          marker.appendChild(dot);
          marker.appendChild(label);
          stationLine.appendChild(marker);

          if(autoScrollTrainNo===trainNo) {
            setTimeout(()=> marker.scrollIntoView({behavior:'smooth', block:'center'}),100);
          }

          currentTrainNos.push(trainNo);

          // å³å´åˆ—è¡¨è³‡è¨Š
          const info = document.createElement('div');
          info.className='train-info-item';
          info.innerHTML=`
            <div><strong>ğŸš†${trainNo}æ¬¡ <span style="color:${color}">${trainType}</span></strong>(${fromStation1} â ${toStation1})</div>
            <div>âš«ç›®å‰åœ¨ ${posInfo.currentBetweenStart} â ${posInfo.currentBetweenEnd} é–“</div>
            <div>âš«ä¸‹ä¸€ç«™ï¼š${posInfo.nextStation}ï¼ˆ${posInfo.nextTime}ï¼‰</div>
            <div><small>
              å·²è¡Œé§›ï¼š${Math.max(0,traveled)}/${Math.max(0,totalDuration)} åˆ†é˜ (å®Œæˆ${progress.toFixed(1)}%) ï¼Œ
              å‰©é¤˜ï¼š${Math.max(0,remain)} åˆ†é˜æŠµé”çµ‚é»ç«™ ã€‚
            </small></div>
          `;
          info.onclick = ()=>{
            autoScrollTrainNo= trainNo;
            updateTrains(currentMinutes);
          };
          infoList.appendChild(info);

          const i1 = stations.indexOf(posInfo.currentBetweenStart);
          const i2 = stations.indexOf(posInfo.currentBetweenEnd);
          if(i1!==-1 && i2!==-1) {
            segmentCounts[Math.min(i1,i2)]++;
          }
        });

        // æ›´æ–° station label çš„ incoming
        document.querySelectorAll('.station-label').forEach(lbl=>{
          const nm= lbl.dataset.name;
          lbl.innerHTML= nm;
          if(incomingMap[nm]){
            const icon = document.createElement('span');
            icon.className='incoming-train-indicator';
            icon.innerText='ğŸ”œ';
            lbl.appendChild(icon);
          }
        });

        // é€šçŸ¥æ–°ä¸Šç·šåˆ—è»Š
        notifyNewTrains(currentTrainNos);

        // ç¹ªè£½å€æ®µç†±åº¦
        drawHotnessCanvas();

        // ç´€éŒ„æœ¬æ¬¡ "flow" (segmentCountsä¹‹å’Œ)
        const totalFlow = segmentCounts.reduce((a,b)=>a+b,0);
        flowHistory.push({ time: currentMinutes, flow: totalFlow});
        // éå¤šå°±åˆªé™¤èˆŠçš„
        if(flowHistory.length>50) {
          flowHistory.splice(0, flowHistory.length-50);
        }
        drawFlowChart();
      }

      // ç›£è½è¼¸å…¥æ¡†
      document.getElementById('trainSearchInput')?.addEventListener('input', ()=>{
        updateTrains(parseInt(timeSlider.value));
      });
      timeSlider?.addEventListener('input', e=>{
        updateTrains(parseInt(e.target.value));
      });

      updateTrains(parseInt(timeSlider.value));

      setInterval(()=>{
        if(useRealtime){
          const now = new Date();
          const val = now.getHours()*60 + now.getMinutes();
          timeSlider.value= val;
          updateTrains(val);
        } else if(autoAdvance){
          let val = parseInt(timeSlider.value);
          val= (val+ speedMultiplier)%1440;
          timeSlider.value= val;
          updateTrains(val);
        }
      },10000);

      // ç«™åæœå°‹ä¸¦è·³è½‰
      const stationSearchInput = document.getElementById('searchInput');
      if(stationSearchInput){
        stationSearchInput.addEventListener('input', ()=>{
          const kw = stationSearchInput.value.trim();
          if(!kw) return;
          const idx = stations.findIndex(s => s.includes(kw));
          if(idx!==-1){
            const matchedStation= stations[idx];
            const lblEl= document.querySelector(`.station-label[data-name="${matchedStation}"]`);
            if(lblEl){
              lblEl.scrollIntoView({behavior:'smooth', block:'center'});
              lblEl.classList.add('highlight');
              setTimeout(()=> lblEl.classList.remove('highlight'),2000);
            }
          }
        });
      }
    });
  </script>
</body>
</html>