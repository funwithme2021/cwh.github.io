<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美食地圖探索｜智慧旅遊中心</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/global.css" />
  <link rel="stylesheet" href="../assets/css/section-food.css" />
  <link rel="stylesheet" href="food-style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script defer src="../assets/js/site.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <style>
    #map {
      width: 100%;
      height: 640px;
    }
    .map-legend {
      position: absolute;
      bottom: 20px;
      right: 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow);
      padding: 0.85rem 1rem;
      font-size: 0.85rem;
      color: var(--text);
      display: grid;
      gap: 0.4rem;
    }
    .map-legend .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .map-legend .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    .marker-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body data-base-path=".." data-section="food" data-page="map">
  <main class="page-content">
    <section class="food-hero">
      <div>
        <span class="badge">Gourmet Map</span>
        <h1>以地圖探索車站周邊的高分美食</h1>
        <p>結合動態等第、篩選工具與定位功能，快速鎖定符合條件的熱門店家，並支援即時導航與評分洞察。</p>
      </div>
      <div class="highlight-grid">
        <div class="food-highlight">
          <span class="label">可視範圍</span>
          <span class="value">全台車站周邊</span>
        </div>
        <div class="food-highlight">
          <span class="label">支援篩選</span>
          <span class="value">城市・類別・價位・等第</span>
        </div>
        <div class="food-highlight">
          <span class="label">地圖工具</span>
          <span class="value">Marker Cluster / GPS</span>
        </div>
        <div class="food-highlight">
          <span class="label">資料筆數</span>
          <span class="value" id="mapSampleCount">-- 筆</span>
        </div>
      </div>
    </section>

    <section class="food-panel">
      <header>
        <div>
          <h2>篩選與搜尋</h2>
          <p>可選擇下拉條件或以關鍵字快速搜尋，亦可啟用定位顯示鄰近店家，適合規劃臨時用餐安排。</p>
        </div>
        <div id="google_translate_element"></div>
      </header>
      <div class="map-layout">
        <div class="map-panel">
          <div class="radio-group" style="display:flex; gap:1rem;">
            <label><input type="radio" name="searchMode" value="mode1" checked> 下拉式篩選</label>
            <label><input type="radio" name="searchMode" value="mode2"> 關鍵字搜尋</label>
          </div>
          <div id="filterContainer" class="filter-grid">
            <label>城市
              <select id="mapCitySelect"></select>
            </label>
            <label>區域
              <select id="mapDistSelect"></select>
            </label>
            <label>類別
              <select id="mapCategorySelect"></select>
            </label>
            <label>價位
              <select id="mapPriceSelect"></select>
            </label>
            <label>等第
              <select id="mapGradeSelect"></select>
            </label>
          </div>
          <div id="keywordContainer" class="filter-grid" style="display:none;">
            <label>關鍵字
              <input type="text" id="keywordInput" placeholder="輸入店名、城市或類別關鍵字" />
            </label>
          </div>
          <div class="filter-actions">
            <button id="mapSearchBtn" class="btn-primary" type="button">套用篩選</button>
            <button id="locateMeBtn" type="button">定位到我的位置</button>
          </div>
          <div class="notice-card">可點擊標記查看店家評分、等第與導航連結。</div>
        </div>
        <div class="iframe-card" style="position:relative;">
          <div id="map"></div>
          <div class="map-legend" id="mapLegend"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="food.js"></script>
  <script>
  const mapStats = {
    sample: document.getElementById('mapSampleCount')
  };
  </script>
  <script>
const WEIGHTS = {
  taste:0.15, freshness:0.10, texture:0.15, appearance:0.10,
  smell:0.10, portion:0.10, uniqueness:0.05, price:0.10,
  environment:0.05, attitude:0.05, others:0.05
};
function computeSingleScore(d){
  return (
    d.taste*WEIGHTS.taste +
    d.freshness*WEIGHTS.freshness +
    d.texture*WEIGHTS.texture +
    d.appearance*WEIGHTS.appearance +
    d.smell*WEIGHTS.smell + d.portion*WEIGHTS.portion +
    d.uniqueness*WEIGHTS.uniqueness + d.price*WEIGHTS.price +
    d.environment*WEIGHTS.environment + d.attitude*WEIGHTS.attitude +
    d.others*WEIGHTS.others
  );
}

const RATIO_GRADE_CONFIG = [
  {grade:"A++",    minRatio:0.03, maxRatio:0.05},
  {grade:"A+",    minRatio:0.08, maxRatio:0.13},
  {grade:"A",    minRatio:0.13, maxRatio:0.20},
  {grade:"B++",    minRatio:0.17, maxRatio:0.23},
  {grade:"B+",    minRatio:0.20, maxRatio:0.25},
  {grade:"B",    minRatio:0.13, maxRatio:0.25},
  {grade:"C",  minRatio:0.05, maxRatio:0.08},
  {grade:"F",      minRatio:0.00, maxRatio:0.05}
];
function assignRatioGrades(arr, maxIter=5){
  arr.sort((a,b)=> computeSingleScore(b)- computeSingleScore(a));
  let n= arr.length;
  if(n===0) return arr;

  let start=0;
  for(let i=0;i<RATIO_GRADE_CONFIG.length;i++){
    const cfg= RATIO_GRADE_CONFIG[i];
    const mid= (cfg.minRatio+ cfg.maxRatio)/2;
    const slotCount= Math.round(mid*n);
    if(i=== RATIO_GRADE_CONFIG.length-1){
      for(let j=start;j<n;j++){
        arr[j].ratioGrade= cfg.grade;
      }
      break;
    } else {
      const end= Math.min(start+slotCount,n);
      for(let j=start;j<end;j++){
        arr[j].ratioGrade= cfg.grade;
      }
      start= end;
    }
  }

  for(let iter=0; iter<maxIter; iter++){
    const countMap={};
    arr.forEach(d=>{ countMap[d.ratioGrade]=(countMap[d.ratioGrade]||0)+1; });
    for(let i=0;i<RATIO_GRADE_CONFIG.length;i++){
      const cfg= RATIO_GRADE_CONFIG[i];
      const g= cfg.grade;
      const c= countMap[g]||0;
      const ratio= c/n;
      if(ratio>cfg.maxRatio && i<RATIO_GRADE_CONFIG.length-1){
        const overCount= Math.round(c- cfg.maxRatio*n);
        if(overCount>0){
          const same= arr.filter(d=> d.ratioGrade===g)
            .sort((a,b)=> computeSingleScore(a)-computeSingleScore(b));
          for(let k=0;k<overCount && k<same.length;k++){
            same[k].ratioGrade= RATIO_GRADE_CONFIG[i+1].grade;
          }
        }
      } else if(ratio<cfg.minRatio && i>0){
        const shortage= Math.round(cfg.minRatio*n - c);
        if(shortage>0){
          const prev= arr.filter(d=> d.ratioGrade===RATIO_GRADE_CONFIG[i-1].grade)
            .sort((a,b)=> computeSingleScore(a)-computeSingleScore(b));
          for(let k=0;k<shortage && k<prev.length;k++){
            prev[prev.length-1-k].ratioGrade= g;
          }
        }
      }
    }
    arr.sort((a,b)=> computeSingleScore(b)- computeSingleScore(a));
  }
  return arr;
}

function populateSelect(sel, values, placeholder){
  sel.innerHTML='';
  const opt = document.createElement('option');
  opt.value='';
  opt.textContent= placeholder;
  sel.appendChild(opt);
  values.forEach(value=>{
    const option = document.createElement('option');
    option.value = value;
    option.textContent = value;
    sel.appendChild(option);
  });
}

function filterData(data){
  const mode = document.querySelector('input[name="searchMode"]:checked').value;
  let filtered = [...data];
  if(mode==='mode1'){
    const city = document.getElementById('mapCitySelect').value;
    const dist = document.getElementById('mapDistSelect').value;
    const category = document.getElementById('mapCategorySelect').value;
    const price = document.getElementById('mapPriceSelect').value;
    const grade = document.getElementById('mapGradeSelect').value;
    filtered = filtered.filter(item=>{
      if(city && item.city!==city) return false;
      if(dist && item.district!==dist) return false;
      if(category && item.category!==category) return false;
      if(price && item.priceLevel!==price) return false;
      if(grade && item.ratioGrade!==grade) return false;
      return true;
    });
  } else {
    const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
    if(kw){
      filtered = filtered.filter(item=>{
        const text = `${item.storeName}${item.city}${item.district}${item.category}${item.priceLevel}`.toLowerCase();
        return text.includes(kw);
      });
    }
  }
  return filtered;
}

function getColorByGrade(grade){
  const colors={
    'A++':'#d62839','A+':'#f95738','A':'#f4a261','B++':'#2a9d8f',
    'B+':'#2b8a6d','B':'#277da1','C':'#6a4c93','F':'#6d6d6d'
  };
  return colors[grade] || '#888';
}

let map, markers;

function renderMap(){
  assignRatioGrades(foodData,5);
  if(mapStats.sample){ mapStats.sample.textContent = `${foodData.length} 筆`; }

  const citySet = new Set();
  const districtSet = new Set();
  const categorySet = new Set();
  const priceSet = new Set();
  const gradeSet = new Set();
  foodData.forEach(item=>{
    if(item.city) citySet.add(item.city);
    if(item.district) districtSet.add(item.district);
    if(item.category) categorySet.add(item.category);
    if(item.priceLevel) priceSet.add(item.priceLevel);
    if(item.ratioGrade) gradeSet.add(item.ratioGrade);
  });
  populateSelect(document.getElementById('mapCitySelect'), [...citySet], '全部城市');
  populateSelect(document.getElementById('mapDistSelect'), [...districtSet], '全部區域');
  populateSelect(document.getElementById('mapCategorySelect'), [...categorySet], '全部類別');
  populateSelect(document.getElementById('mapPriceSelect'), [...priceSet], '全部價位');
  populateSelect(document.getElementById('mapGradeSelect'), [...gradeSet], '全部等第');

  map = L.map('map').setView([23.6978, 120.9605], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  markers = L.markerClusterGroup();
  map.addLayer(markers);

  updateMarkers(foodData);
  renderLegend();
}

function updateMarkers(data){
  markers.clearLayers();
  const filtered = filterData(data);
  filtered.forEach(item=>{
    if(!item.lat || !item.lng){ return; }
    const grade = item.ratioGrade || 'F';
    const color = getColorByGrade(grade);
    const divIcon = L.divIcon({
      className:'',
      html:`<div class="marker-icon" style="background:${color};"></div>`,
      iconSize:[24,24]
    });
    const marker = L.marker([item.lat, item.lng], {icon:divIcon});
    const popup = `
      <strong>${item.storeName}</strong><br>
      評分：${computeSingleScore(item).toFixed(2)} / 100<br>
      等第：${grade}<br>
      類別：${item.category}｜價位：${item.priceLevel}<br>
      <a href="${item.gmapUrl}" target="_blank" rel="noopener">前往 Google 地圖</a>
    `;
    marker.bindPopup(popup);
    markers.addLayer(marker);
  });
}

function renderLegend(){
  const legend = document.getElementById('mapLegend');
  legend.innerHTML = '';
  ['A++','A+','A','B++','B+','B','C','F'].forEach(grade=>{
    const item = document.createElement('div');
    item.className = 'legend-item';
    const dot = document.createElement('span');
    dot.className = 'legend-color';
    dot.style.background = getColorByGrade(grade);
    item.appendChild(dot);
    const label = document.createElement('span');
    label.textContent = grade;
    item.appendChild(label);
    legend.appendChild(item);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  renderMap();

  document.querySelectorAll('input[name="searchMode"]').forEach(radio=>{
    radio.addEventListener('change', (e)=>{
      if(e.target.value==='mode1'){
        document.getElementById('filterContainer').style.display='grid';
        document.getElementById('keywordContainer').style.display='none';
      } else {
        document.getElementById('filterContainer').style.display='none';
        document.getElementById('keywordContainer').style.display='grid';
      }
      updateMarkers(foodData);
    });
  });

  document.getElementById('mapSearchBtn').addEventListener('click', ()=>{
    updateMarkers(foodData);
  });

  document.getElementById('mapCitySelect').addEventListener('change', ()=>{
    const city = document.getElementById('mapCitySelect').value;
    const districtSelect = document.getElementById('mapDistSelect');
    const districts = new Set();
    foodData.forEach(item=>{
      if(!city || item.city===city){ districts.add(item.district); }
    });
    populateSelect(districtSelect, [...districts], '全部區域');
  });

  document.getElementById('locateMeBtn').addEventListener('click', ()=>{
    if(!navigator.geolocation){
      alert('瀏覽器不支援定位功能');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 14);
      const userMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: '#2563eb',
        fillColor: '#60a5fa',
        fillOpacity: 0.7
      }).addTo(map);
      userMarker.bindPopup('我的位置').openPopup();
    }, ()=>{
      alert('無法取得定位資訊，請確認權限設定。');
    });
  });
});

function googleTranslateElementInit(){
  new google.translate.TranslateElement({pageLanguage:'zh-TW'},
    'google_translate_element'
  );
}
  </script>
  <script type="text/javascript"
    src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit">
  </script>
</body>
</html>
