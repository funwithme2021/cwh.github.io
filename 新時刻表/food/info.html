<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美食評分細項與動態等第｜智慧旅遊中心</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/global.css" />
  <link rel="stylesheet" href="../assets/css/section-food.css" />
  <link rel="stylesheet" href="food-style.css" />
  <script defer src="../assets/js/site.js"></script>
</head>
<body data-base-path=".." data-section="food" data-page="stories">
  <main class="page-content">
    <section class="food-hero">
      <div>
        <span class="badge">Scoring Insight</span>
        <h1>了解美食評分細項與動態等第算法</h1>
        <p>解析十一項評分指標、加權設定與自動等第分配邏輯，協助旅人與商家掌握評分背後的依據與調整方向。</p>
      </div>
      <div class="highlight-grid">
        <div class="food-highlight">
          <span class="label">最高權重</span>
          <span class="value">口味・口感 (各 15%)</span>
        </div>
        <div class="food-highlight">
          <span class="label">等第級距</span>
          <span class="value">A++ 至 F 共 8 級</span>
        </div>
        <div class="food-highlight">
          <span class="label">評分樣本</span>
          <span class="value" id="storySampleCount">-- 筆</span>
        </div>
        <div class="food-highlight">
          <span class="label">自動翻譯</span>
          <span class="value">支援 Google Translate</span>
        </div>
      </div>
    </section>

    <section class="food-panel" id="gradeOverview">
      <header>
        <div>
          <h2>動態等第對照表</h2>
          <p>即時計算各等第的預期比例、實際佔比與當前分數區間，可快速掌握哪些店家落在高分段。</p>
        </div>
        <div id="google_translate_element"></div>
      </header>
      <div class="table-container">
        <table id="gradeTable">
          <thead>
            <tr>
              <th>等第</th>
              <th>預估比例 (min~max)</th>
              <th>動態分數範圍</th>
              <th>目前實際比例</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="food-panel">
      <header>
        <div>
          <h2>評分細項說明</h2>
          <p>十一項指標涵蓋味覺、服務到整體體驗，透過加權計算確保評分能同時反映美味程度與用餐品質。</p>
        </div>
      </header>
      <div class="story-grid">
        <article class="story-card">
          <h3>價格</h3>
          <ul>
            <li>評估價位與品質、份量的對應關係。</li>
            <li>比較同類型餐點的價格合理性。</li>
            <li>衡量是否符合旅客預算期待。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>外觀（含擺盤）</h3>
          <ul>
            <li>觀察色澤與擺盤是否吸引人。</li>
            <li>評估創意與精緻度，提升用餐儀式感。</li>
            <li>確認視覺呈現是否符合餐點定位。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>氣味</h3>
          <ul>
            <li>嗅覺是否誘人並展現食材特色。</li>
            <li>評估香氣層次感與持久度。</li>
            <li>排除可能影響體驗的不良氣味。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>口感</h3>
          <ul>
            <li>感受口中的質地與層次。</li>
            <li>判斷熟度與處理是否恰當。</li>
            <li>多樣的口感帶來更佳驚喜。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>口味</h3>
          <ul>
            <li>衡量酸甜苦辣鹹的平衡度。</li>
            <li>檢視調味是否襯托食材。</li>
            <li>評估味道是否富含層次。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>食材新鮮度</h3>
          <ul>
            <li>檢視色澤、質地與口感是否新鮮。</li>
            <li>避免變質或不適合食用的狀態。</li>
            <li>特別關注海鮮、生食等敏感食材。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>分量</h3>
          <ul>
            <li>評估份量是否能滿足旅客需求。</li>
            <li>比較市場行情以判斷合理性。</li>
            <li>兼顧不同客群的飽足程度。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>獨特性</h3>
          <ul>
            <li>辨識創意料理與地域特色。</li>
            <li>展現主廚巧思，打造記憶點。</li>
            <li>強化推薦價值與分享意願。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>環境</h3>
          <ul>
            <li>包含清潔度、動線與氛圍。</li>
            <li>評估是否適合不同旅遊情境。</li>
            <li>關注無障礙與親子友善設施。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>態度</h3>
          <ul>
            <li>觀察服務專業度與親切度。</li>
            <li>衡量是否能主動協助旅客需求。</li>
            <li>服務品質是口碑與回訪關鍵。</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>其他（等候時間等）</h3>
          <ul>
            <li>包含候位時間、出餐速度與點餐便利。</li>
            <li>評估是否提供線上預約、外帶服務。</li>
            <li>整體流程順暢度左右體驗滿意度。</li>
          </ul>
        </article>
      </div>
    </section>

    <section class="food-panel">
      <header>
        <div>
          <h2>動態等第運作機制</h2>
          <p>利用多次迭代計算讓等第比例落在合理區間，並根據實際分數自動調整各級門檻。</p>
        </div>
      </header>
      <div class="story-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
        <article class="story-card">
          <h3>演算法概念</h3>
          <p>系統會先依分數排序，再按預期比例分配等第。若某等級超出或不足，透過迭代將邊界的店家移動，以符合設定範圍。</p>
        </article>
        <article class="story-card">
          <h3>加權比例</h3>
          <p>各指標加權總和為 100%。味覺相關占最大權重，其次為價格、分量與服務，確保評分兼顧美味與體驗。</p>
          <ul>
            <li>口味 / 口感：各 15%</li>
            <li>氣味 / 外觀 / 分量 / 價格：各 10%</li>
            <li>食材新鮮度：10%</li>
            <li>獨特性 / 環境 / 態度 / 其他：各 5%</li>
          </ul>
        </article>
        <article class="story-card">
          <h3>應用建議</h3>
          <p>商家可依此了解應優先改善的指標；旅客則能根據等第與細項找到符合期待的餐廳，規劃更順暢的行程。</p>
        </article>
      </div>
    </section>
  </main>

  <script src="food.js"></script>
  <script>
  const storyStats = {
    sample: document.getElementById('storySampleCount')
  };
  </script>
  <script>
function computeSingleScore(d){
  const WEIGHTS = {
    taste: 0.15, freshness: 0.10, texture: 0.15,
    appearance: 0.10, smell: 0.10, portion: 0.10,
    uniqueness: 0.05, price: 0.10, environment: 0.05,
    attitude: 0.05, others: 0.05
  };
  return (
    d.taste*WEIGHTS.taste +
    d.freshness*WEIGHTS.freshness +
    d.texture*WEIGHTS.texture +
    d.appearance*WEIGHTS.appearance +
    d.smell*WEIGHTS.smell +
    d.portion*WEIGHTS.portion +
    d.uniqueness*WEIGHTS.uniqueness +
    d.price*WEIGHTS.price +
    d.environment*WEIGHTS.environment +
    d.attitude*WEIGHTS.attitude +
    d.others*WEIGHTS.others
  );
}

const RATIO_GRADE_CONFIG = [
  {grade:"A++",    minRatio:0.03, maxRatio:0.05},
  {grade:"A+",    minRatio:0.08, maxRatio:0.13},
  {grade:"A",    minRatio:0.13, maxRatio:0.20},
  {grade:"B++",    minRatio:0.17, maxRatio:0.23},
  {grade:"B+",    minRatio:0.20, maxRatio:0.25},
  {grade:"B",    minRatio:0.13, maxRatio:0.25},
  {grade:"C",  minRatio:0.05, maxRatio:0.08},
  {grade:"F",      minRatio:0.00, maxRatio:0.05}
];

function assignRatioGrades(data, maxIterations=5){
  data.sort((a,b)=> computeSingleScore(b) - computeSingleScore(a));
  const n = data.length;
  if(n===0) return data;

  let start=0;
  for(let i=0; i<RATIO_GRADE_CONFIG.length; i++){
    const cfg= RATIO_GRADE_CONFIG[i];
    const midRatio= (cfg.minRatio + cfg.maxRatio)/2;
    const slotCount= Math.round(midRatio*n);
    if(i=== RATIO_GRADE_CONFIG.length-1){
      for(let j=start; j<n; j++){
        data[j].ratioGrade= cfg.grade;
      }
      break;
    } else {
      const endIndex= Math.min(start+ slotCount, n);
      for(let j=start; j<endIndex; j++){
        data[j].ratioGrade= cfg.grade;
      }
      start= endIndex;
    }
  }

  for(let iter=0; iter<maxIterations; iter++){
    let gradeCountMap={};
    data.forEach(d=>{
      gradeCountMap[d.ratioGrade] = (gradeCountMap[d.ratioGrade]||0)+1;
    });
    for(let i=0; i<RATIO_GRADE_CONFIG.length; i++){
      const cfg= RATIO_GRADE_CONFIG[i];
      const g  = cfg.grade;
      const c  = gradeCountMap[g]||0;
      const ratio= c/n;
      if(ratio> cfg.maxRatio && i<RATIO_GRADE_CONFIG.length-1){
        const overCount= Math.round(c - cfg.maxRatio*n);
        if(overCount>0){
          let sameGArr= data.filter(d=> d.ratioGrade=== g);
          sameGArr.sort((a,b)=> computeSingleScore(a)-computeSingleScore(b));
          for(let k=0; k<overCount && k<sameGArr.length; k++){
            sameGArr[k].ratioGrade= RATIO_GRADE_CONFIG[i+1].grade;
          }
        }
      } else if(ratio< cfg.minRatio && i>0){
        const shortCount= Math.round(cfg.minRatio*n - c);
        if(shortCount>0){
          const prevG= RATIO_GRADE_CONFIG[i-1].grade;
          let prevArr= data.filter(d=> d.ratioGrade=== prevG);
          prevArr.sort((a,b)=> computeSingleScore(a)-computeSingleScore(b));
          for(let k=0; k<shortCount && k<prevArr.length; k++){
            let item= prevArr[prevArr.length-1-k];
            item.ratioGrade= g;
          }
        }
      }
    }
    data.sort((a,b)=> computeSingleScore(b) - computeSingleScore(a));
    gradeCountMap={};
    data.forEach(d=>{
      gradeCountMap[d.ratioGrade] = (gradeCountMap[d.ratioGrade]||0)+1;
    });
  }
  return data;
}

document.addEventListener("DOMContentLoaded", ()=>{
  const tableBody= document.querySelector('#gradeTable tbody');
  if(!foodData || foodData.length===0){
    tableBody.innerHTML = '<tr><td colspan="4">目前沒有店家資料</td></tr>';
    return;
  }

  assignRatioGrades(foodData, 5);
  foodData.sort((a,b)=> computeSingleScore(b)-computeSingleScore(a));
  if(storyStats.sample){ storyStats.sample.textContent = `${foodData.length} 筆`; }

  const total= foodData.length;
  const infoMap={};
  RATIO_GRADE_CONFIG.forEach(cfg=>{
    infoMap[cfg.grade]= {count:0, minScore:null, maxScore:null};
  });

  foodData.forEach(d=>{
    const g= d.ratioGrade;
    if(!infoMap[g]){
      infoMap[g]= {count:0, minScore:null, maxScore:null};
    }
    infoMap[g].count++;
    const sc= computeSingleScore(d);
    if(infoMap[g].minScore===null || sc< infoMap[g].minScore){
      infoMap[g].minScore= sc;
    }
    if(infoMap[g].maxScore===null || sc> infoMap[g].maxScore){
      infoMap[g].maxScore= sc;
    }
  });

  let html="";
  RATIO_GRADE_CONFIG.forEach(cfg=>{
    const g= cfg.grade;
    const obj= infoMap[g] || {count:0, minScore:null, maxScore:null};
    const c= obj.count;
    const ratio= total ? (c/total*100).toFixed(2)+"%" : "0%";
    const ratioRange= `${(cfg.minRatio*100).toFixed(0)}% ~ ${(cfg.maxRatio*100).toFixed(0)}%`;
    let scRange= "<span class='score-range'>無店家</span>";
    if(obj.minScore!==null){
      scRange= `<span class="score-range">${obj.minScore.toFixed(2)} ~ ${obj.maxScore.toFixed(2)}</span>`;
    }

    html += `
      <tr>
        <td>${g}</td>
        <td>${ratioRange}</td>
        <td>${scRange}</td>
        <td>${ratio}</td>
      </tr>
    `;
  });
  tableBody.innerHTML = html;
});

function googleTranslateElementInit(){
  new google.translate.TranslateElement({pageLanguage:'zh-TW'},
    'google_translate_element'
  );
}
  </script>
  <script type="text/javascript"
    src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit">
  </script>
</body>
</html>
