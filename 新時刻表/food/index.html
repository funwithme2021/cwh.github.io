<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美食評分總覽｜智慧旅遊中心</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/global.css" />
  <link rel="stylesheet" href="../assets/css/section-food.css" />
  <link rel="stylesheet" href="food-style.css" />
  <script defer src="../assets/js/site.js"></script>
</head>
<body data-base-path=".." data-section="food" data-page="overview">
  <main class="page-content">
    <section class="food-hero">
      <div>
        <span class="badge">Gourmet Radar</span>
        <h1>沿線人氣美食即時排行與精選推薦</h1>
        <p>整合車站周邊的店家評分、距離與價位資訊，透過多種智慧篩選與自動等第計算，協助旅人輕鬆鎖定最適合的餐飲選擇。</p>
      </div>
      <div class="highlight-grid">
        <div class="food-highlight">
          <span class="label">資料筆數</span>
          <span class="value" id="totalStoreCount">--</span>
        </div>
        <div class="food-highlight">
          <span class="label">最高等第</span>
          <span class="value" id="topGradeLabel">--</span>
        </div>
        <div class="food-highlight">
          <span class="label">最新評分日期</span>
          <span class="value" id="latestReviewDate">--</span>
        </div>
        <div class="food-highlight">
          <span class="label">支援查詢</span>
          <span class="value">下拉 / 關鍵字 / 最近距離</span>
        </div>
      </div>
    </section>

    <section class="food-panel">
      <header>
        <div>
          <h2>智慧搜尋與排序</h2>
          <p>可依照城市、區域、類別、價位與自動等第快速篩選，或切換為關鍵字模式。支援分制切換、排序與每頁顯示設定，同時可啟用定位找出最近的熱門店家。</p>
        </div>
        <span class="food-badge">自動等第計算</span>
      </header>

      <div class="map-panel" style="padding:1.1rem; gap:0.75rem;">
        <div class="inline-toolbar" style="justify-content: space-between; width:100%;">
          <div class="radio-group" style="display:flex; gap:1rem; align-items:center;">
            <label><input type="radio" name="searchMode" value="mode1" checked> 下拉式篩選</label>
            <label><input type="radio" name="searchMode" value="mode2"> 關鍵字搜尋</label>
          </div>
          <div id="google_translate_element"></div>
        </div>
        <div id="filterContainer" class="filter-grid">
          <label>城市
            <select id="citySelect"></select>
          </label>
          <label>區域
            <select id="districtSelect"></select>
          </label>
          <label>類別
            <select id="categorySelect"></select>
          </label>
          <label>價位
            <select id="priceSelect"></select>
          </label>
          <label>等第
            <select id="gradeSelect"></select>
          </label>
        </div>
        <div id="keywordContainer" class="filter-grid" style="display:none;">
          <label>關鍵字
            <input type="text" id="keywordInput" placeholder="輸入店名、城市或類別關鍵字" />
          </label>
        </div>
        <div class="filter-grid">
          <label>分制
            <select id="scoreScaleSelect">
              <option value="100" selected>100 分制</option>
              <option value="5">5 分制</option>
            </select>
          </label>
          <label>排序
            <select id="sortSelect">
              <option value="desc" selected>由高到低</option>
              <option value="asc">由低到高</option>
            </select>
          </label>
          <label>每頁顯示
            <select id="pageSizeSelect">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
            </select>
          </label>
        </div>
        <div class="filter-actions">
          <button id="searchBtn" class="btn-primary" type="button">開始查詢</button>
          <button id="resetBtn" type="button">重置條件</button>
          <button id="nearestBtn" type="button">定位後顯示最近 20 間</button>
        </div>
      </div>

      <div id="gradeSummary" class="notice">自動載入統計中…</div>
    </section>

    <section class="food-panel">
      <header>
        <div>
          <h2>人氣榜單</h2>
          <p>根據多項指標綜合計算的平均分數與等第排序，點擊平均分即可檢視各細項的等第分佈，亦可快速導向地圖查看路線。</p>
        </div>
      </header>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:70px;">排名</th>
              <th>店家</th>
              <th class="score-col">平均分</th>
              <th class="grade-col">等第</th>
              <th class="dist-col">距離</th>
              <th>城市(區域)</th>
              <th>類別</th>
              <th>價位</th>
              <th>評分時間</th>
              <th style="width:80px;">導航</th>
            </tr>
          </thead>
          <tbody id="resultTbody"></tbody>
        </table>
      </div>
      <div class="pagination food-pagination">
        <button id="prevPageBtn" type="button">&laquo; 上一頁</button>
        <span id="pageInfo"></span>
        <button id="nextPageBtn" type="button">下一頁 &raquo;</button>
      </div>
    </section>
  </main>

  <div id="detailPopup" class="detail-popup">
    <h4>細項評分等第</h4>
    <ul id="detailList"></ul>
    <button id="closePopupBtn" type="button">關閉</button>
  </div>

  <script src="food.js"></script>
  <script>
  const heroStats = {
    total: document.getElementById('totalStoreCount'),
    topGrade: document.getElementById('topGradeLabel'),
    latest: document.getElementById('latestReviewDate')
  };
  </script>
  <script>
/* ========== 1) 動態等第邏輯(多次迭代) ========== */
const WEIGHTS = {
  taste:0.15, freshness:0.10, texture:0.15, appearance:0.10,
  smell:0.10, portion:0.10, uniqueness:0.05, price:0.10,
  environment:0.05, attitude:0.05, others:0.05
};
function computeSingleScore(d){
  return (
    d.taste*WEIGHTS.taste +
    d.freshness*WEIGHTS.freshness +
    d.texture*WEIGHTS.texture +
    d.appearance*WEIGHTS.appearance +
    d.smell*WEIGHTS.smell + d.portion*WEIGHTS.portion +
    d.uniqueness*WEIGHTS.uniqueness + d.price*WEIGHTS.price +
    d.environment*WEIGHTS.environment + d.attitude*WEIGHTS.attitude +
    d.others*WEIGHTS.others
  );
}
const RATIO_GRADE_CONFIG=[
  {grade:"A++",    minRatio:0.03, maxRatio:0.05},
  {grade:"A+",    minRatio:0.08, maxRatio:0.13},
  {grade:"A",    minRatio:0.13, maxRatio:0.20},
  {grade:"B++",    minRatio:0.17, maxRatio:0.23},
  {grade:"B+",    minRatio:0.20, maxRatio:0.25},
  {grade:"B",    minRatio:0.13, maxRatio:0.25},
  {grade:"C",  minRatio:0.05, maxRatio:0.08},
  {grade:"F",      minRatio:0.00, maxRatio:0.05}
];
function assignRatioGrades(arr, maxIter=5){
  arr.sort((a,b)=> computeSingleScore(b)-computeSingleScore(a));
  let n= arr.length;
  if(n===0) return arr;

  let start=0;
  for(let i=0;i<RATIO_GRADE_CONFIG.length;i++){
    let cfg= RATIO_GRADE_CONFIG[i];
    let mid= (cfg.minRatio+ cfg.maxRatio)/2;
    let slotCount= Math.round(mid*n);
    if(i=== RATIO_GRADE_CONFIG.length-1){
      for(let j=start;j<n;j++){
        arr[j].ratioGrade= cfg.grade;
      }
      break;
    } else {
      let end= Math.min(start+slotCount,n);
      for(let j=start;j<end;j++){
        arr[j].ratioGrade= cfg.grade;
      }
      start= end;
    }
  }

  for(let iter=0; iter<maxIter; iter++){
    let gCount={};
    arr.forEach(d=>{
      gCount[d.ratioGrade]= (gCount[d.ratioGrade]||0)+1;
    });
    for(let i=0;i<RATIO_GRADE_CONFIG.length;i++){
      let cfg= RATIO_GRADE_CONFIG[i];
      let g= cfg.grade;
      let c= gCount[g]||0;
      let ratio= c/n;
      if(ratio>cfg.maxRatio && i<RATIO_GRADE_CONFIG.length-1){
        let overCount= Math.round(c- cfg.maxRatio*n);
        if(overCount>0){
          let sameArr= arr.filter(x=> x.ratioGrade===g);
          sameArr.sort((a,b)=> computeSingleScore(a)-computeSingleScore(b));
          for(let k=0;k<overCount && k<sameArr.length;k++){
            sameArr[k].ratioGrade= RATIO_GRADE_CONFIG[i+1].grade;
          }
        }
      } else if(ratio<cfg.minRatio && i>0){
        let shortCount= Math.round(cfg.minRatio*n - c);
        if(shortCount>0){
          let prevG= RATIO_GRADE_CONFIG[i-1].grade;
          let prevArr= arr.filter(x=> x.ratioGrade===prevG);
          prevArr.sort((a,b)=> computeSingleScore(a)-computeSingleScore(b));
          for(let k=0;k<shortCount && k<prevArr.length;k++){
            prevArr[prevArr.length-1-k].ratioGrade= g;
          }
        }
      }
    }
    arr.sort((a,b)=> computeSingleScore(b)-computeSingleScore(a));
    gCount={};
    arr.forEach(d=>{
      gCount[d.ratioGrade]=(gCount[d.ratioGrade]||0)+1;
    });
  }
  return arr;
}

/* ========== 2) 下拉 / 關鍵字 ========== */
function distinct(arr,key){
  return [...new Set(arr.map(d=> d[key]).filter(Boolean))];
}
function populate(sel, arr, def){
  sel.innerHTML="";
  let o= document.createElement("option");
  o.value=""; o.textContent= def;
  sel.appendChild(o);
  arr.forEach(v=>{
    let opt= document.createElement("option");
    opt.value= v;
    opt.textContent= v;
    sel.appendChild(opt);
  });
}

// 初始化
function initSelectOptions(){
  populate(document.getElementById("citySelect"), distinct(foodData,"city"), "全部");
  populate(document.getElementById("districtSelect"), distinct(foodData,"district"), "全部");
  populate(document.getElementById("categorySelect"), distinct(foodData,"category"), "全部");
  populate(document.getElementById("priceSelect"), distinct(foodData,"priceLevel"), "全部");

  assignRatioGrades(foodData,5);
  let gSet= new Set();
  foodData.forEach(d=> gSet.add(d.ratioGrade));
  populate(document.getElementById("gradeSelect"), [...gSet], "全部");

  if(heroStats.total){
    heroStats.total.textContent = foodData.length.toString();
  }
  if(heroStats.latest){
    const latest = foodData.reduce((max, item) => Math.max(max, new Date(item.time).getTime()), 0);
    if(latest){
      const date = new Date(latest);
      const formatted = `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}`;
      heroStats.latest.textContent = formatted;
    }
  }
}

function updateDistrictOptions(){
  let cityVal= document.getElementById("citySelect").value;
  let arr= foodData;
  if(cityVal) arr= arr.filter(x=> x.city=== cityVal);
  let distArr= distinct(arr,"district");
  populate(document.getElementById("districtSelect"), distArr, "全部");
}

function filterByDropdown(data){
  let c= document.getElementById("citySelect").value;
  let dist= document.getElementById("districtSelect").value;
  let cat= document.getElementById("categorySelect").value;
  let pri= document.getElementById("priceSelect").value;
  let grd= document.getElementById("gradeSelect").value;

  return data.filter(d=>{
    if(c && d.city!== c) return false;
    if(dist && d.district!== dist) return false;
    if(cat && d.category!== cat) return false;
    if(pri && d.priceLevel!== pri) return false;
    if(grd && d.ratioGrade!== grd) return false;
    return true;
  });
}
function filterByKeyword(data){
  let kw= document.getElementById("keywordInput").value.trim().toLowerCase();
  if(!kw) return data;
  return data.filter(d=>{
    let combo= (d.storeName + d.city + d.district + d.category + d.priceLevel).toLowerCase();
    return combo.includes(kw);
  });
}
function getSearchMode(){
  return document.querySelector('input[name="searchMode"]:checked').value;
}

/* ========== 3) 分制 & 排序 & 每頁顯示 ========== */
function getScoreText(d){
  let raw= computeSingleScore(d);
  let scale= document.getElementById("scoreScaleSelect").value;
  if(scale==="5"){
    return (raw/20).toFixed(4);
  } else {
    return raw.toFixed(4);
  }
}
function sortData(arr){
  let sortSel= document.getElementById("sortSelect").value;
  arr.sort((a,b)=>{
    let sa= computeSingleScore(a);
    let sb= computeSingleScore(b);
    return (sortSel==="asc")?(sa-sb):(sb-sa);
  });
  return arr;
}

/* ========== 全域變數 + 分頁 ========== */
let finalData= [];
let currentPage=1;
let pageSize=20;

function performSearch(){
  assignRatioGrades(foodData,5);

  let result=[];
  if(getSearchMode()==="mode1"){
    result= filterByDropdown(foodData);
  } else {
    result= filterByKeyword(foodData);
  }

  result= sortData(result);

  finalData= result;
  currentPage=1;
  renderTablePage();
}

function renderTablePage(){
  pageSize= parseInt(document.getElementById("pageSizeSelect").value,10);
  let start= (currentPage-1)* pageSize;
  let end= currentPage* pageSize;
  let slice= finalData.slice(start,end);

  let rankMap={};
  let itemCount=0, lastScore=null, curRank=0;
  finalData.forEach(d=>{
    itemCount++;
    let sc= computeSingleScore(d).toFixed(2);
    if(sc!== lastScore){
      curRank= itemCount;
      lastScore= sc;
    }
    rankMap[d.storeName]= curRank;
  });

  if(heroStats.topGrade){
    const topItem = finalData[0] || foodData[0];
    heroStats.topGrade.textContent = topItem ? `${computeSingleScore(topItem).toFixed(1)} 分（${topItem.ratioGrade || '—'}）` : '--';
  }

  let tbody= document.getElementById("resultTbody");
  tbody.innerHTML= "";
  slice.forEach(d=>{
    let tr= document.createElement("tr");
    let grade= d.ratioGrade;
    let score= getScoreText(d);

    let tdRank= document.createElement("td");
    tdRank.textContent= rankMap[d.storeName];

    let tdStore= document.createElement("td");
    let link= document.createElement("a");
    link.href= `map.html?storeName=${encodeURIComponent(d.storeName)}`;
    link.textContent= d.storeName;
    tdStore.appendChild(link);

    let tdScore= document.createElement("td");
    tdScore.textContent= score;
    tdScore.classList.add( getGradeColorClass(grade) );
    tdScore.style.cursor="pointer";
    tdScore.addEventListener("click",(evt)=> showDetailPopup(evt,d));

    let tdGrade= document.createElement("td");
    tdGrade.textContent= grade;
    tdGrade.classList.add( getGradeColorClass(grade) );

    let tdDist= document.createElement("td");
    tdDist.textContent= d.distance? `${d.distance.toFixed(1)} km` : "-";

    let tdCity= document.createElement("td");
    tdCity.textContent= `${d.city} (${d.district})`;

    let tdCategory= document.createElement("td");
    tdCategory.textContent= d.category;

    let tdPrice= document.createElement("td");
    tdPrice.textContent= d.priceLevel;

    let tdTime= document.createElement("td");
    tdTime.textContent= d.time;

    let tdNav= document.createElement("td");
    if(d.gmapUrl){
      let navLink= document.createElement("a");
      navLink.href= d.gmapUrl;
      navLink.target= "_blank";
      navLink.rel= "noopener";
      navLink.textContent= "開啟地圖";
      tdNav.appendChild(navLink);
    } else {
      tdNav.textContent= "-";
    }

    [tdRank, tdStore, tdScore, tdGrade, tdDist, tdCity, tdCategory, tdPrice, tdTime, tdNav].forEach(cell=> tr.appendChild(cell));
    tbody.appendChild(tr);
  });

  let total= finalData.length;
  let totalPage= Math.max(1, Math.ceil(total/pageSize));
  document.getElementById("pageInfo").textContent= `第 ${currentPage} / ${totalPage} 頁，總共 ${total} 筆`;

  updateGradeSummary();
}

function updateGradeSummary(){
  let summaryEl= document.getElementById("gradeSummary");
  if(!summaryEl) return;
  let gCountMap={};
  finalData.forEach(d=>{
    let g= d.ratioGrade||"F";
    gCountMap[g]=(gCountMap[g]||0)+1;
  });
  let total= finalData.length;
  if(total===0){
    summaryEl.textContent = "目前沒有符合條件的店家，請嘗試調整篩選條件。";
    return;
  }
  let parts=[`目前顯示 ${total} 筆資料`];
  ["A++","A+","A","B++","B+","B","C","F"].forEach(g=>{
    let c= gCountMap[g]||0;
    let pct= (c/total*100).toFixed(1);
    parts.push(`${g}：${c} 筆 (${pct}%)`);
  });
  summaryEl.textContent= parts.join("｜");
}

/* ========== 點擊平均分 => 細項popup ========== */
const detailPopup= document.getElementById("detailPopup");
const detailList= document.getElementById("detailList");
document.getElementById("closePopupBtn").addEventListener("click",()=>{
  detailPopup.style.display="none";
});
function getItemLetter(score){
  if(score>=94) return "A++";
  if(score>=88) return "A+";
  if(score>=80) return "A";
  if(score>=70) return "B++";
  if(score>=60) return "B+";
  if(score>=45) return "B";
  if(score>=25) return "C";
  return "F";
}
function showDetailPopup(evt, rowData){
  detailList.innerHTML= "";
  let items=[
    {label:"口味", val:getItemLetter(rowData.taste)},
    {label:"食材新鮮度", val:getItemLetter(rowData.freshness)},
    {label:"口感", val:getItemLetter(rowData.texture)},
    {label:"外觀", val:getItemLetter(rowData.appearance)},
    {label:"氣味", val:getItemLetter(rowData.smell)},
    {label:"分量", val:getItemLetter(rowData.portion)},
    {label:"獨特性", val:getItemLetter(rowData.uniqueness)},
    {label:"價格", val:getItemLetter(rowData.price)},
    {label:"環境", val:getItemLetter(rowData.environment)},
    {label:"態度", val:getItemLetter(rowData.attitude)},
    {label:"其他", val:getItemLetter(rowData.others)}
  ];
  items.forEach(x=>{
    let li= document.createElement("li");
    li.textContent= `${x.label}：${x.val}`;
    detailList.appendChild(li);
  });
  detailPopup.style.display= "block";
  detailPopup.style.top= (evt.clientY + window.scrollY)+"px";
  detailPopup.style.left= evt.clientX +"px";
}

function resetSearch() {
  document.getElementById("citySelect").value = "";
  document.getElementById("districtSelect").value = "";
  document.getElementById("categorySelect").value = "";
  document.getElementById("priceSelect").value = "";
  document.getElementById("gradeSelect").value = "";
  document.getElementById("keywordInput").value = "";

  document.getElementById("scoreScaleSelect").value = "100";
  document.getElementById("sortSelect").value = "desc";
  document.getElementById("pageSizeSelect").value = "20";

  document.querySelector('input[name="searchMode"][value="mode1"]').checked = true;
  document.getElementById("filterContainer").style.display = "";
  document.getElementById("keywordContainer").style.display = "none";

  performSearch();
}

/* ========== 使用者定位 => 最近20間 ========== */
function haversineDistKm(lat1,lng1, lat2,lng2){
  const R=6371;
  let dLat= (lat2-lat1)*Math.PI/180;
  let dLng= (lng2-lng1)*Math.PI/180;
  let a=
    Math.sin(dLat/2)* Math.sin(dLat/2)+
    Math.cos(lat1*Math.PI/180)* Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)* Math.sin(dLng/2);
  let c= 2* Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function showNearest10(){
  if(!navigator.geolocation){
    alert("瀏覽器不支援 geolocation");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    let lat= pos.coords.latitude;
    let lng= pos.coords.longitude;

    finalData.forEach(d=>{
      if(d.lat && d.lng){
        d.distance= haversineDistKm(lat,lng, d.lat,d.lng);
      } else {
        d.distance= Infinity;
      }
    });
    finalData.sort((a,b)=> a.distance- b.distance);
    finalData= finalData.slice(0,20);
    currentPage=1;
    renderTablePage();
    alert("已顯示距離最近的20間(目前篩選結果)");
  }, err=>{
    alert("定位失敗或被拒絕");
  });
}

/* ========== DOM Loaded ========== */
document.addEventListener("DOMContentLoaded", ()=>{
  initSelectOptions();
  document.getElementById("citySelect").addEventListener("change", ()=>{
    let cityVal= document.getElementById("citySelect").value;
    let arr= foodData;
    if(cityVal) arr= arr.filter(x=> x.city=== cityVal);
    populate(document.getElementById("districtSelect"),
      distinct(arr,"district"), "全部"
    );
  });

  document.querySelectorAll('input[name="searchMode"]').forEach(r=>{
    r.addEventListener("change",(e)=>{
      if(e.target.value==="mode1"){
        document.getElementById("filterContainer").style.display="";
        document.getElementById("keywordContainer").style.display="none";
      } else {
        document.getElementById("filterContainer").style.display="none";
        document.getElementById("keywordContainer").style.display="";
      }
    });
  });

  document.getElementById("searchBtn").addEventListener("click", performSearch);
  document.getElementById("resetBtn").addEventListener("click", resetSearch);
  document.getElementById("nearestBtn").addEventListener("click", showNearest10);

  document.getElementById("prevPageBtn").addEventListener("click",()=>{
    if(currentPage>1){
      currentPage--;
      renderTablePage();
    }
  });
  document.getElementById("nextPageBtn").addEventListener("click",()=>{
    let total= finalData.length;
    let totalPage= Math.ceil(total/pageSize);
    if(currentPage< totalPage){
      currentPage++;
      renderTablePage();
    }
  });

  document.getElementById("closePopupBtn").addEventListener("click",()=>{
    document.getElementById("detailPopup").style.display="none";
  });

  resetSearch();
});

function googleTranslateElementInit(){
  new google.translate.TranslateElement({pageLanguage:'zh-TW'},
    'google_translate_element'
  );
}
  </script>
  <script
    type="text/javascript"
    src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit">
  </script>
</body>
</html>
