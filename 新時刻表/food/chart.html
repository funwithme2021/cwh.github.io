<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>美食數據圖表｜智慧旅遊中心</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/global.css" />
  <link rel="stylesheet" href="../assets/css/section-food.css" />
  <link rel="stylesheet" href="food-style.css" />
  <script defer src="../assets/js/site.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-base-path=".." data-section="food" data-page="chart">
  <main class="page-content">
    <section class="food-hero">
      <div>
        <span class="badge">Gourmet Analytics</span>
        <h1>評分分佈與城市趨勢視覺化</h1>
        <p>透過多種圖表觀察等第佔比、細項平均、城市熱度與評分表現，快速掌握站點周邊餐飲市場的樣貌，協助規劃旅程與商圈佈局。</p>
      </div>
      <div class="highlight-grid">
        <div class="food-highlight">
          <span class="label">整體平均分 (100)</span>
          <span class="value" id="heroAvg100">--</span>
        </div>
        <div class="food-highlight">
          <span class="label">整體平均分 (5)</span>
          <span class="value" id="heroAvg5">--</span>
        </div>
        <div class="food-highlight">
          <span class="label">城市數量</span>
          <span class="value" id="heroCityCount">--</span>
        </div>
        <div class="food-highlight">
          <span class="label">支援功能</span>
          <span class="value">等第動態 / 城市分析</span>
        </div>
      </div>
    </section>

    <section class="food-panel">
      <header>
        <div>
          <h2>整體指標</h2>
          <p>自動計算全體店家的平均分數、等第分配與細項評分，並支援 Google 翻譯、城市榜單切換與堆疊分析。</p>
        </div>
        <div id="google_translate_element"></div>
      </header>
      <div class="notice">圖表資料以最新評分結果計算，若有新店家加入可重新整理更新。</div>
      <div class="chart-grid">
        <article class="chart-card">
          <header>
            <h3>整體平均分</h3>
            <p>掌握全部店家的綜合評分，支援 100 分制與 5 分制切換。</p>
          </header>
          <div class="food-stats" style="grid-template-columns: repeat(auto-fit,minmax(160px,1fr));">
            <div class="stat-card">
              <span class="label">100 分制</span>
              <span class="value" id="avg100">--</span>
            </div>
            <div class="stat-card">
              <span class="label">5 分制</span>
              <span class="value" id="avg5">--</span>
            </div>
          </div>
        </article>

        <article class="chart-card">
          <header>
            <h3>等第分配</h3>
            <p>觀察各等第佔比，掌握整體服務品質結構。</p>
          </header>
          <figure class="chart-frame">
            <canvas id="gradeBarChart"></canvas>
          </figure>
        </article>

        <article class="chart-card">
          <header>
            <h3>細項評分雷達</h3>
            <p>比較口味、環境、價格等指標的平均表現，了解消費者偏好。</p>
          </header>
          <figure class="chart-frame">
            <canvas id="itemRadarChart"></canvas>
          </figure>
        </article>

        <article class="chart-card">
          <header>
            <h3>城市熱門指標</h3>
            <p>切換查看店家數量與平均分數前五名城市，鎖定最熱門站點。</p>
          </header>
          <div class="city-tabs">
            <button id="btnCityCount" class="btn-primary" type="button" style="padding:0.5rem 1rem;">店家數 Top5</button>
            <button id="btnCityAvg" type="button" style="padding:0.5rem 1rem;">平均分 Top5</button>
          </div>
          <figure class="chart-frame city-chart-container">
            <canvas id="cityCountChart" class="city-chart-canvas active"></canvas>
            <canvas id="cityAvgChart" class="city-chart-canvas"></canvas>
          </figure>
        </article>

        <article class="chart-card">
          <header>
            <h3>城市 × 等第堆疊</h3>
            <p>以堆疊長條展示主要城市中各等第的分布情況，快速辨識高品質聚落。</p>
          </header>
          <figure class="chart-frame">
            <canvas id="cityGradeStackedChart"></canvas>
          </figure>
        </article>
      </div>
    </section>
  </main>

  <script src="food.js"></script>
  <script>
const heroWidgets = {
  avg100: document.getElementById('heroAvg100'),
  avg5: document.getElementById('heroAvg5'),
  cityCount: document.getElementById('heroCityCount')
};
  </script>
  <script>
function computeSingleScore(d){
  const WEIGHTS = {
    taste:0.15, freshness:0.10, texture:0.15, appearance:0.10, smell:0.10,
    portion:0.10, uniqueness:0.05, price:0.10, environment:0.05, attitude:0.05, others:0.05
  };
  return (
    d.taste*WEIGHTS.taste + d.freshness*WEIGHTS.freshness + d.texture*WEIGHTS.texture +
    d.appearance*WEIGHTS.appearance + d.smell*WEIGHTS.smell + d.portion*WEIGHTS.portion +
    d.uniqueness*WEIGHTS.uniqueness + d.price*WEIGHTS.price + d.environment*WEIGHTS.environment +
    d.attitude*WEIGHTS.attitude + d.others*WEIGHTS.others
  );
}

function calcOverallAverage(arr){
  if(arr.length===0) return {avg100:0, avg5:0};
  const total = arr.reduce((sum,d)=> sum+ computeSingleScore(d),0);
  const avg100 = total/arr.length;
  return { avg100, avg5: avg100/20 };
}

function assignGrades(data){
  const config=[
    {grade:"A++", minRatio:0.03, maxRatio:0.05},
    {grade:"A+", minRatio:0.08, maxRatio:0.13},
    {grade:"A", minRatio:0.13, maxRatio:0.20},
    {grade:"B++", minRatio:0.17, maxRatio:0.23},
    {grade:"B+", minRatio:0.20, maxRatio:0.25},
    {grade:"B", minRatio:0.13, maxRatio:0.25},
    {grade:"C", minRatio:0.05, maxRatio:0.08},
    {grade:"F", minRatio:0.00, maxRatio:0.05}
  ];
  const arr=[...data];
  arr.sort((a,b)=> computeSingleScore(b)-computeSingleScore(a));
  const n= arr.length;
  let start=0;
  config.forEach((cfg, idx)=>{
    const mid = (cfg.minRatio+cfg.maxRatio)/2;
    const count = idx === config.length-1 ? n-start : Math.round(mid*n);
    for(let i=start;i<Math.min(start+count,n);i++){
      arr[i].ratioGrade= cfg.grade;
    }
    start += count;
  });
  return arr;
}

function groupBy(arr, key){
  return arr.reduce((map,item)=>{
    const k = item[key]||'未分類';
    map[k] = map[k]||[];
    map[k].push(item);
    return map;
  },{});
}

function renderCharts(){
  const gradedData = assignGrades(foodData.map(item=> ({...item})));
  const avg = calcOverallAverage(gradedData);
  document.getElementById('avg100').textContent = avg.avg100.toFixed(2);
  document.getElementById('avg5').textContent = avg.avg5.toFixed(2);
  if(heroWidgets.avg100){ heroWidgets.avg100.textContent = avg.avg100.toFixed(1); }
  if(heroWidgets.avg5){ heroWidgets.avg5.textContent = avg.avg5.toFixed(2); }

  const cityGroups = groupBy(gradedData, 'city');
  if(heroWidgets.cityCount){ heroWidgets.cityCount.textContent = Object.keys(cityGroups).length.toString(); }

  const gradeCounts={};
  gradedData.forEach(item=>{
    gradeCounts[item.ratioGrade] = (gradeCounts[item.ratioGrade]||0)+1;
  });
  const gradeLabels=["A++","A+","A","B++","B+","B","C","F"];
  new Chart(document.getElementById('gradeBarChart'),{
    type:'bar',
    data:{
      labels: gradeLabels,
      datasets:[{
        label:'店家數',
        data: gradeLabels.map(g=> gradeCounts[g]||0),
        backgroundColor:'rgba(255, 138, 76, 0.7)',
        borderRadius:8
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#475569'}},
        y:{beginAtZero:true,ticks:{color:'#475569'}}
      }
    }
  });

  const radarLabels=['口味','食材新鮮度','口感','外觀','氣味','分量','獨特性','價格','環境','態度','其他'];
  const radarValues = radarLabels.map(key=>{
    const field = {
      '口味':'taste','食材新鮮度':'freshness','口感':'texture','外觀':'appearance','氣味':'smell',
      '分量':'portion','獨特性':'uniqueness','價格':'price','環境':'environment','態度':'attitude','其他':'others'
    }[key];
    return gradedData.reduce((sum,item)=> sum+ item[field],0)/gradedData.length;
  });
  new Chart(document.getElementById('itemRadarChart'),{
    type:'radar',
    data:{
      labels: radarLabels,
      datasets:[{
        label:'平均分數',
        data: radarValues,
        backgroundColor:'rgba(67, 97, 238, 0.15)',
        borderColor:'rgba(67, 97, 238, 0.6)',
        borderWidth:2,
        pointBackgroundColor:'rgba(67, 97, 238, 0.8)'
      }]
    },
    options:{
      responsive:true,
      scales:{
        r:{
          suggestedMin:60,
          suggestedMax:95,
          angleLines:{color:'rgba(71,85,105,0.3)'},
          grid:{color:'rgba(71,85,105,0.2)'},
          pointLabels:{color:'#475569'}
        }
      }
    }
  });

  const cityEntries = Object.entries(cityGroups);
  const cityCounts = cityEntries.map(([city, list])=>({city, count:list.length}));
  const cityAvgScores = cityEntries.map(([city, list])=>({city, score:list.reduce((sum,item)=> sum+computeSingleScore(item),0)/list.length}));
  cityCounts.sort((a,b)=> b.count-a.count);
  cityAvgScores.sort((a,b)=> b.score-a.score);

  const countCtx = document.getElementById('cityCountChart');
  const avgCtx = document.getElementById('cityAvgChart');

  const countChart = new Chart(countCtx,{
    type:'bar',
    data:{
      labels: cityCounts.slice(0,5).map(item=> item.city),
      datasets:[{
        label:'店家數',
        data: cityCounts.slice(0,5).map(item=> item.count),
        backgroundColor:'rgba(33, 150, 243, 0.7)',
        borderRadius:8
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#475569'}},
        y:{beginAtZero:true,ticks:{color:'#475569'}}
      }
    }
  });

  const avgChart = new Chart(avgCtx,{
    type:'bar',
    data:{
      labels: cityAvgScores.slice(0,5).map(item=> item.city),
      datasets:[{
        label:'平均分',
        data: cityAvgScores.slice(0,5).map(item=> item.score.toFixed(2)),
        backgroundColor:'rgba(102, 187, 106, 0.7)',
        borderRadius:8
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#475569'}},
        y:{beginAtZero:true,ticks:{color:'#475569'}}
      }
    }
  });

  document.getElementById('btnCityCount').addEventListener('click', ()=>{
    document.getElementById('btnCityCount').classList.add('btn-primary');
    document.getElementById('btnCityAvg').classList.remove('btn-primary');
    countCtx.classList.add('active');
    avgCtx.classList.remove('active');
  });
  document.getElementById('btnCityAvg').addEventListener('click', ()=>{
    document.getElementById('btnCityAvg').classList.add('btn-primary');
    document.getElementById('btnCityCount').classList.remove('btn-primary');
    countCtx.classList.remove('active');
    avgCtx.classList.add('active');
  });

  const gradeByCity={};
  gradeLabels.forEach(g=> gradeByCity[g]={});
  cityEntries.forEach(([city, list])=>{
    gradeLabels.forEach(g=>{
      gradeByCity[g][city] = 0;
    });
    list.forEach(item=>{
      gradeByCity[item.ratioGrade][city] = (gradeByCity[item.ratioGrade][city]||0)+1;
    });
  });
  const mainCities = cityCounts.slice(0,6).map(item=> item.city);
  new Chart(document.getElementById('cityGradeStackedChart'),{
    type:'bar',
    data:{
      labels: mainCities,
      datasets: gradeLabels.map((grade,idx)=>({
        label: grade,
        data: mainCities.map(city=> gradeByCity[grade][city]||0),
        backgroundColor: `hsla(${idx*35},70%,55%,0.8)`
      }))
    },
    options:{
      responsive:true,
      scales:{
        x:{stacked:true, ticks:{color:'#475569'}},
        y:{stacked:true, beginAtZero:true, ticks:{color:'#475569'}}
      }
    }
  });
}

function googleTranslateElementInit(){
  new google.translate.TranslateElement({pageLanguage:'zh-TW'},
    'google_translate_element'
  );
}

document.addEventListener('DOMContentLoaded', ()=>{
  renderCharts();
});
  </script>
  <script
    type="text/javascript"
    src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit">
  </script>
</body>
</html>
